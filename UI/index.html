<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Timesheet</title>
  <link rel="stylesheet" href="css/main.css">
</head>
<body>
  <div class="page-container">

    <!-- Header -->
    <header class="app-header" style="justify-content: center;">
      <h1>Timesheet</h1>
    </header>

    <!-- Menu utama -->
    <section class="menu-grid2">
      <button class="btn btn-primary" style="height: 150px; font-size:20px" id="prodstart">Productive</button>
      <button class="btn btn-primary" style="height: 150px;font-size:20px" id="unprod">Unproductive</button>
      <button class="btn btn-primary" style="height: 150px;font-size:20px" id="prodstop">Stop Timesheet</button>
      <button class="btn btn-primary"style="height: 150px;font-size:20px" >Tools & Consumable</button>
      <button class="btn btn-primary"style="height: 150px;font-size:20px" onclick="goregister()">NFC Register</button>
    </section>

    <!-- Status bar -->
    <footer class="status-bar">
      <div>Status: <span id="status">Idle</span></div>
      <div>ID NFC: <span id="nfcid">-</span></div>
    </footer>
  </div>

  <script src="js/script.js"></script>
  <script>
    // Element referensi
    const btnStart  = document.getElementById("prodstart");
    const btnStop   = document.getElementById("prodstop");
    const btnUnprod = document.getElementById("unprod");
    const statusEl  = document.getElementById("status");
    const nfcidEl   = document.getElementById("nfcid");

    function setStatus(msg) { statusEl.textContent = msg; }

    function getTextRecord(e) {
      const recs = e.message?.records || [];
      for (const r of recs) {
        if (r.recordType === "text") {
          try { return new TextDecoder(r.encoding || "utf-8").decode(r.data); }
          catch {}
        }
      }
      return "";
    }

    function extractNfcId(e) {
      if (e.serialNumber && e.serialNumber.trim()) return e.serialNumber.trim();
      return getTextRecord(e).trim();
    }

    async function getUserByNfc(nfcid) {
      const res = await fetch(`/usernfc/nfcid/${nfcid}`);
      if (!res.ok) return null;
      const data = await res.json().catch(() => null);
      return data && Object.keys(data).length ? data : null;
    }

    async function stopAllByNfc(nfcid) {
      const res = await fetch(`/usernfc/checkout/${nfcid}`);
      return res.ok;
    }

    async function handleScan(action) {
      if (!("NDEFReader" in window)) {
        setStatus("Web NFC tidak didukung di browser ini");
        return;
      }
      try {
        const reader = new NDEFReader();
        await reader.scan();
        setStatus("Scanning... tempelkan tag NFC");
        reader.onreading = async (event) => {
          const nfcid = extractNfcId(event);
          nfcidEl.textContent = nfcid || "-";
          if (!nfcid) { setStatus("ID NFC kosong"); return; }
          const user = await getUserByNfc(nfcid);
          if (!user) { setStatus("User tidak ditemukan"); return; }

          if (action === "start") {
            sessionStorage.setItem("datakaryawan", JSON.stringify(user));
            setStatus("User ditemukan, pindah ke mainmenu...");
            window.location.href = "mainmenu";
          } else if (action === "stop") {
            const ok = await stopAllByNfc(nfcid);
            setStatus(ok ? "Berhasil stop semua timesheet" : "Gagal stop timesheet");
          } else if (action === "unprodni") {
            sessionStorage.setItem("datakaryawan", JSON.stringify(user));
            setStatus("User ditemukan, pindah ke unprod...");
            window.location.href = "unprodmenu";
          }
        };
        reader.onreadingerror = () => setStatus("Gagal membaca NFC");
      } catch (err) {
        setStatus("Tidak bisa mulai scan: " + err.message);
      }
    }

    btnStart.addEventListener("click", () => handleScan("start"));
    btnStop.addEventListener("click", () => handleScan("stop"));
    btnUnprod.addEventListener("click", () => handleScan("unprodni"));
  </script>
</body>
</html>
