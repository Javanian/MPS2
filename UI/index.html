
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Timesheet</title>
<link rel="stylesheet" href="css/main.css">

<style>
/* ===== SWITCH MODE ===== */
.mode-switch {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
}

.switch {
  position: relative;
  width: 50px;
  height: 26px;
}

.switch input { display: none; }

.slider {
  position: absolute;
  cursor: pointer;
  background: #ccc;
  border-radius: 26px;
  inset: 0;
  transition: .3s;
}

.slider::before {
  content: "";
  position: absolute;
  height: 22px;
  width: 22px;
  left: 2px;
  bottom: 2px;
  background: white;
  border-radius: 50%;
  transition: .3s;
}

input:checked + .slider {
  background: #4CAF50;
}

input:checked + .slider::before {
  transform: translateX(24px);
}

/* ===== INPUT BOX ===== */
.input-box {
  display: none;
  justify-content: center;
  align-items: center;
  border: 1px solid #ccc;
  border-radius: 6px;
  width: 100%;
  height: 170px;
}

.input-box input {
  width: 100%;
  height: 150px;
  font-size: 50px;
  border: none;
  outline: none;
  text-align: center;
}

/* ===== BUTTON DEFAULT (MELEMBUNG) ===== */
.menu-grid2 .btn {
  transition: all 0.15s ease-in-out;
  box-shadow: 0 6px 0 #999;
  transform: translateY(0);
  opacity: 1;
}

/* ===== BUTTON DIPILIH (DISABLED + KE DALAM) ===== */
.menu-grid2 .btn.selected {
  box-shadow: inset 0 4px 6px rgba(0,0,0,0.35);
  transform: translateY(3px);
  opacity: 0.6;
  pointer-events: none; /* ðŸ”¥ benar-benar disabled */
}

/* ===== WARNA KHUSUS (OPTIONAL) ===== */
.menu-grid2 .btn.selected#prodstop {
  background-color: #d9534f !important; /* merah stop */
}

.menu-grid2 .btn.selected#prodstart {
  background-color: #4CAF50 !important;
}

.menu-grid2 .btn.selected#unprod {
  background-color: #f0ad4e !important;
}

</style>
</head>

<body>
<div class="page-container">

<!-- HEADER -->
<header class="app-header" style="justify-content: space-between; align-items:center;">
  <h1>Timesheet</h1>

  <div class="mode-switch">
    <span id="modeLabel">Internal</span>
    <label class="switch">
      <input type="checkbox" id="modeToggle">
      <span class="slider"></span>
    </label>
  </div>
</header>

<!-- MENU -->
<section class="menu-grid2">
  <button class="btn btn-primary" style="height:150px;font-size:20px" id="prodstart">Productive</button>
  <button class="btn btn-primary" style="height:150px;font-size:20px" id="unprod">Unproductive</button>
  <button class="btn btn-primary" style="height:150px;font-size:20px" id="prodstop">Stop Timesheet</button>
  <button class="btn btn-primary" style="height:150px;font-size:20px">Tools & Consumable</button>
</section>

<!-- INPUT EKSTERNAL -->
<div class="input-box" id="externalBox">
  <input id="scanInput"
         type="password"
         inputmode="numeric"
         autocomplete="off"
         placeholder="SCAN ID EKSTERNAL">
</div>

<!-- STATUS -->
<footer class="status-bar">
  <div>Status: <span id="status">Idle</span></div>
  <div>Version: <span>1.0.0</span></div>
  <div>ID NFC: <span id="nfcid">-</span></div>
</footer>

</div>

<script src="js/script.js"></script>

<script>

  
/* ===== COMMON ===== */
const btnStart  = document.getElementById("prodstart");
const btnStop   = document.getElementById("prodstop");
const btnUnprod = document.getElementById("unprod");
const statusEl  = document.getElementById("status");
const nfcidEl   = document.getElementById("nfcid");

function setStatus(msg) {
  statusEl.textContent = msg;
}

/* ===== API ===== */
async function getUserByNfc(nfcid) {
  const res = await fetch(`/usernfc/nfcid/${nfcid}`);
  if (!res.ok) return null;
  const data = await res.json().catch(() => null);
  return data && Object.keys(data).length ? data : null;
}

async function stopAllByNfc(nfcid) {
  const res = await fetch(`/usernfc/checkout/${nfcid}`);
  return res.ok;
}

/* ===== NFC HELPERS ===== */
function getTextRecord(e) {
  const recs = e.message?.records || [];
  for (const r of recs) {
    if (r.recordType === "text") {
      try { return new TextDecoder(r.encoding || "utf-8").decode(r.data); }
      catch {}
    }
  }
  return "";
}

function extractNfcId(e) {
  if (e.serialNumber && e.serialNumber.trim()) return e.serialNumber.trim();
  return getTextRecord(e).trim();
}

/* ===== MODE HANDLING ===== */
const modeToggle = document.getElementById("modeToggle");
const modeLabel  = document.getElementById("modeLabel");
const externalBox = document.getElementById("externalBox");
const input = document.getElementById("scanInput");

function focusInput() {
  if (currentMode === "external") {
    setTimeout(() => input.focus(), 0);
  }
}
let currentMode = sessionStorage.getItem("scanMode") || "internal";


function setMode(mode) {
  currentMode = mode;
  sessionStorage.setItem("scanMode", mode);

  if (mode === "internal") {
    modeLabel.textContent = "Internal";
    externalBox.style.display = "none";
    setStatus("Mode Internal (NFC)");
  } else {
    modeLabel.textContent = "Eksternal";
    externalBox.style.display = "flex";
    setStatus("Mode Eksternal (Scanner)");
    focusInput();
  }
}

modeToggle.addEventListener("change", () => {
  setMode(modeToggle.checked ? "external" : "internal");
});

modeToggle.checked = currentMode === "external";
setMode(currentMode);


/* ===== NFC HANDLER ===== */
async function handleScan(action) {
  if (currentMode !== "internal") return;

  if (!("NDEFReader" in window)) {
    setStatus("Web NFC tidak didukung");
    return;
  }

  try {
    const reader = new NDEFReader();
    await reader.scan();
    setStatus("Scanning NFC...");

    reader.onreading = async (event) => {
      const nfcid = extractNfcId(event);
      nfcidEl.textContent = nfcid || "-";
      if (!nfcid) return;

      const user = await getUserByNfc(nfcid);
      if (!user) {
        setStatus("User tidak ditemukan");
        return;
      }

      if (action === "start") {
        sessionStorage.setItem("datakaryawan", JSON.stringify(user));
        window.location.href = "mainmenu";
      } else if (action === "stop") {
        await stopAllByNfc(nfcid);
        setStatus("Timesheet dihentikan");
      } else if (action === "unprod") {
        sessionStorage.setItem("datakaryawan", JSON.stringify(user));
        window.location.href = "unprodmenu";
      }
    };
  } catch (err) {
    setStatus("Gagal scan NFC");
  }
}

/* ===== BUTTON EVENTS ===== */
let currentAction = sessionStorage.getItem("scanAction") || "start";


btnStart.onclick = () => {
  currentAction = "start";
  sessionStorage.setItem("scanAction", currentAction);
  updateButtonUI();  
  handleScan("start");
};

btnUnprod.onclick = () => {
  currentAction = "unprod";
  sessionStorage.setItem("scanAction", currentAction);
  updateButtonUI();  
  handleScan("unprod");
};

btnStop.onclick = () => {
  currentAction = "stop";
  sessionStorage.setItem("scanAction", currentAction);
  updateButtonUI();  
  handleScan("stop");
};

function updateButtonUI() {
  const buttons = [
    { el: btnStart, action: "start" },
    { el: btnUnprod, action: "unprod" },
    { el: btnStop, action: "stop" }
  ];

  buttons.forEach(btn => {
    btn.el.classList.remove("selected");
    btn.el.disabled = false;

    if (btn.action === currentAction) {
      btn.el.classList.add("selected"); // ðŸ”¥ INI YANG BIKIN DISABLED
      btn.el.disabled = true;           // ðŸ”¥ BENAR-BENAR MATI
    }
  });
}

/* ===== EXTERNAL SCAN (ENTER) ===== */
input.addEventListener("keydown", async (e) => {
  if (e.key !== "Enter") return;
  if (currentMode !== "external") return;

  const id = input.value.trim();
  input.value = "";              // ðŸ”¥ AUTO CLEAR LANGSUNG
  focusInput();                  // ðŸ”¥ BALIK FOKUS

  if (!id) return;

  nfcidEl.textContent = id;

  const user = await getUserByNfc(id);
  if (!user) {
    setStatus("User tidak ditemukan");
    return;
  }

  if (currentAction === "stop") {
    await stopAllByNfc(id);
    setStatus("Timesheet dihentikan");
    return;
  }

  sessionStorage.setItem("datakaryawan", JSON.stringify(user));

  if (currentAction === "unprod") {
    window.location.href = "unprodmenu";
  } else {
    window.location.href = "mainmenu";
  }
});

// Fokus saat load
window.addEventListener("load", focusInput);

// Kalau blur
input.addEventListener("blur", focusInput);

// Klik di mana pun â†’ balik fokus
document.addEventListener("click", focusInput);

</script>
</body>
</html>
