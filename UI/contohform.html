<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=960, height=482">
<title>Process Control UI</title>
<link rel="stylesheet" href="../css/style.css" />
<link rel="stylesheet" href="../css/pss.css" />
</head>
<body>
<div class="container-wrapper">
  <!-- Container 1 : Timesheet -->
  <div class="container" id="container1">
    <h3>Timesheet</h3>
    <label>Pilih Kategori Proses</label>
    <select id="categorySelect" style="height:50px"></select>
    <div class="table-container">
      <table id="timesheetTable">
        <thead>
          <tr>
            <th>Production Order</th>
            <th>SSBR Ident</th>
            <th>Operation Text</th>
            <th>Seq</th>
            <th>Workcenter Code</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Container 2 : Form -->
  <div class="container" id="container2">
    <div class="button-group">
      <button id="btnCreate">Create</button>
      <button id="btnEdit">Edit</button>
      <button id="btnSubmit">Submit</button>
    </div>
    <form id="parameterForm"></form>
  </div>

  <!-- Container 3 : ProcessControlData (hidden by default) -->
  <div class="container" id="container3">
    <div class="button-group">
      <button id="btnBySN">By SN</button>
      <button id="btnByWorkcenter">By Workcenter</button>
    </div>
    <div class="table-container">
      <table id="processControlTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Production Order</th>
            <th>Workcenter</th>
            <th>Validation</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <h4>Parameter Detail</h4>
    <form id="processControlDetailForm"></form>
  </div>
</div>
<script>
const datakaryawan = JSON.parse(sessionStorage.getItem("datakaryawan"));
const serialnumber = datakaryawan.snssb;

const categorySelect = document.getElementById('categorySelect');
const timesheetBody = document.querySelector('#timesheetTable tbody');
const parameterForm = document.getElementById('parameterForm');

const container1 = document.getElementById('container1');
const container2 = document.getElementById('container2');
const container3 = document.getElementById('container3');

const processControlTableBody = document.querySelector('#processControlTable tbody');
const processControlDetailForm = document.getElementById('processControlDetailForm');

async function loadCategories() {
  const res = await fetch('/process-category');
  const data = await res.json();
  categorySelect.innerHTML = data.map(c =>
    `<option value="${c.id_process}">${c.process_name}</option>`).join('');
}

async function loadTimesheet() {
  const res = await fetch(`/timesheet/getsn/${serialnumber}`);
  const data = await res.json();
  timesheetBody.innerHTML = data.map(row =>
    `<tr>
      <td>${row.production_order}</td>
      <td>${row.ssbr_ident}</td>
      <td>${row.operation_text}</td>
      <td>${row.seq}</td>
      <td>${row.workcentercode}</td>
    </tr>`).join('');
}

// save selected timesheet row to sessionStorage
timesheetBody.addEventListener('click', e => {
  const tr = e.target.closest('tr');
  if (!tr) return;
  timesheetBody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
  tr.classList.add('selected');

  const cells = Array.from(tr.children).map(td => td.textContent);
  sessionStorage.setItem("datatimepcs", JSON.stringify({
    production_order: cells[0],
    ssbr_ident: cells[1],
    operation_text: cells[2],
    seq: cells[3],
    workcentercode: cells[4]
  }));
});

// build parameter form (with optional prefill)
async function buildParameterForm(prefill=null){
  parameterForm.innerHTML = '';
  const id_process = categorySelect.value;
  if(!id_process) return alert('Pilih kategori proses');

  const res = await fetch(`/process-parameter?process=${id_process}`);
  const params = await res.json();

  for(const p of params){
    const row = document.createElement('div');
    row.className = 'form-row';
    row.innerHTML = `<label>${p.parameter_name}</label>`;
    const inputBox = document.createElement('div');
    inputBox.className = 'input-box';

    let mainInput;

    if(p.ischoice){
      mainInput = document.createElement('select');
      mainInput.name = `param_${p.id_parameter}`;
      const chRes = await fetch(`/process-parameter-choicebase?parameter=${p.id_parameter}`);
      const choices = await chRes.json();
      mainInput.innerHTML = choices.map(c =>
        `<option value="${c.choice_name}" ${prefill&&prefill[p.id_parameter]===c.choice_name?'selected':''}>
          ${c.choice_name}
        </option>`).join('') + `<option value="Other">Other</option>`;

      const otherInput = document.createElement('input');
      otherInput.type='text';
      otherInput.placeholder='Isi jika Other';
      otherInput.className='other-input';
      otherInput.name=`other_${p.id_parameter}`;
      if(prefill && !(choices.some(c=>c.choice_name===prefill[p.id_parameter]))){
        otherInput.value = prefill[p.id_parameter];
        otherInput.style.display='inline-block';
        mainInput.value='Other';
      }
      mainInput.addEventListener('change',()=>otherInput.style.display = mainInput.value==='Other'?'inline-block':'none');
      inputBox.appendChild(mainInput);
      inputBox.appendChild(otherInput);
    }else{
      mainInput = document.createElement('input');
      mainInput.type = p.isnumber?'number':'text';
      mainInput.name = `param_${p.id_parameter}`;
      mainInput.value = prefill?prefill[p.id_parameter]||'':'';
      inputBox.appendChild(mainInput);
    }

    const uomLabel = document.createElement('div');
    uomLabel.className='uom-label';
    uomLabel.textContent = p.uom || '';

    row.appendChild(inputBox);
    row.appendChild(uomLabel);
    parameterForm.appendChild(row);
  }
}

document.getElementById('btnCreate').addEventListener('click', ()=>buildParameterForm());

// submit create
document.getElementById('btnSubmit').addEventListener('click', async e=>{
  e.preventDefault();
  const datatimepcs = JSON.parse(sessionStorage.getItem("datatimepcs"));
  if(!datatimepcs) return alert('Pilih row timesheet terlebih dahulu');

  const controlRes = await fetch('/process-control',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      production_order: datatimepcs.production_order,
      ssbr_id: datatimepcs.ssbr_ident,
      operation_text: datatimepcs.operation_text,
      operation_no: datatimepcs.seq,
      workcenter: datatimepcs.workcentercode
    })
  });
  const newControl = await controlRes.json();

  for(const row of parameterForm.querySelectorAll('.form-row')){
    const selectEl = row.querySelector('select');
    const otherEl = row.querySelector('.other-input');
    const mainInput = selectEl || row.querySelector('input[type="text"], input[type="number"]');
    const uom = row.querySelector('.uom-label').textContent;
    let value, id_parameter;

    if(selectEl){
      id_parameter = selectEl.name.split('_')[1];
      value = selectEl.value==='Other' ? (otherEl.value||'') : selectEl.value;
    } else {
      id_parameter = mainInput.name.split('_')[1];
      value = mainInput.value;
    }

    await fetch('/process-control-item',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        category_name: categorySelect.options[categorySelect.selectedIndex].text,
        parameter_name: row.querySelector('label').textContent,
        value,
        uom,
        id_parameter,
        processcontroldata_id: newControl.id_processcontroldata
      })
    });
  }
  alert('Data berhasil disimpan');
});

// edit mode: show container3 only
document.getElementById('btnEdit').addEventListener('click', ()=>{
  container1.style.display='none';
  container2.style.display='none';
  container3.style.display='flex';
  loadProcessControl('sn');
});

async function loadProcessControl(mode){
  const url = mode==='sn' ? `/process-control?sn=${datakaryawan.snssb}` : `/process-control?workcenter=${datakaryawan.workcenter}`;
  const res = await fetch(url);
  const data = await res.json();
  processControlTableBody.innerHTML = data.map(r =>
    `<tr data-id="${r.id_processcontroldata}">
       <td>${r.id_processcontroldata}</td>
       <td>${r.production_order}</td>
       <td>${r.workcenter}</td>
       <td>${r.validation_status||''}</td>
     </tr>`).join('');
}

document.getElementById('btnBySN').addEventListener('click',()=>loadProcessControl('sn'));
document.getElementById('btnByWorkcenter').addEventListener('click',()=>loadProcessControl('workcenter'));

processControlTableBody.addEventListener('click', async e=>{
  const tr = e.target.closest('tr');
  if(!tr) return;
  const id = tr.dataset.id;
  const res = await fetch(`/process-control-item?control=${id}`);
  const items = await res.json();
  const prefill = {};
  for(const it of items) prefill[it.id_parameter] = it.value;
  processControlDetailForm.innerHTML = ''; // rebuild form with prefill
  await buildParameterForm(prefill);
  processControlDetailForm.innerHTML = parameterForm.innerHTML;
});

loadCategories();
loadTimesheet();
</script>





</body>
</html>