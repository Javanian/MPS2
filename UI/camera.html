<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Demo Akses Kamera</title>
</head>
<body>
  <h1>Demo Akses Kamera</h1>

  <div>
    <label for="cameraSelect">Pilih kamera:</label>
    <select id="cameraSelect"></select>
    <button id="refreshDevices">Refresh</button>
  </div>

  <div>
    <button id="startBtn">Start Camera</button>
    <button id="stopBtn" disabled>Stop Camera</button>
    <button id="snapBtn" disabled>Ambil Foto</button>
  </div>

  <div>
    <video id="preview" autoplay playsinline muted></video>
  </div>

  <div>
    <h3>Hasil Foto</h3>
    <img id="photo" alt="Hasil foto akan muncul di sini" />
    <p>
      <a id="downloadLink" download="photo.png">Download Foto</a>
    </p>
  </div>

  <script>
    const video = document.getElementById('preview');
    const cameraSelect = document.getElementById('cameraSelect');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const snapBtn = document.getElementById('snapBtn');
    const refreshBtn = document.getElementById('refreshDevices');
    const photo = document.getElementById('photo');
    const downloadLink = document.getElementById('downloadLink');

    let currentStream = null;

    // Muat daftar kamera
    async function loadCameras() {
      // Agar deviceId terlihat, sebagian browser minta kita punya izin media dulu.
      try {
        // Coba izin singkat bila belum pernah (tanpa menyetel stream permanen)
        if (!currentStream) {
          const temp = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          temp.getTracks().forEach(t => t.stop());
        }
      } catch (e) {
        // Abaikan, user bisa klik Start untuk memicu izin
      }

      const devices = await navigator.mediaDevices.enumerateDevices();
      const cameras = devices.filter(d => d.kind === 'videoinput');

      // Isi select
      cameraSelect.innerHTML = "";
      cameras.forEach((cam, idx) => {
        const opt = document.createElement('option');
        opt.value = cam.deviceId;
        opt.textContent = cam.label || `Kamera ${idx + 1}`;
        cameraSelect.appendChild(opt);
      });

      // Tambah opsi facingMode untuk perangkat mobile bila deviceId kosong/privasi
      if (cameras.length === 0) {
        const opt = document.createElement('option');
        opt.value = "";
        opt.textContent = "Kamera tidak terdeteksi";
        cameraSelect.appendChild(opt);
      }
    }

    // Mulai kamera
    async function startCamera() {
      try {
        stopCamera(); // pastikan bersih
        const deviceId = cameraSelect.value;

        // Jika ada deviceId, pakai itu. Jika tidak, fallback ke facingMode user (kamera depan)
        const constraints = deviceId
          ? { video: { deviceId: { exact: deviceId } }, audio: false }
          : { video: { facingMode: 'user' }, audio: false };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        video.srcObject = stream;

        startBtn.disabled = true;
        stopBtn.disabled = false;
        snapBtn.disabled = false;
      } catch (err) {
        alert('Tidak bisa mengakses kamera: ' + err.name + ' - ' + err.message);
        console.error(err);
      }
    }

    // Hentikan kamera
    function stopCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
        currentStream = null;
      }
      video.srcObject = null;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      snapBtn.disabled = true;
    }

    // Ambil foto dari stream
    function takePhoto() {
      if (!video.videoWidth) {
        alert('Video belum siap. Coba lagi setelah preview tampil.');
        return;
      }
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const dataURL = canvas.toDataURL('image/png');
      photo.src = dataURL;
      downloadLink.href = dataURL;
    }

    // Cek izin kamera (opsional)
    async function checkPermission() {
      if (!navigator.permissions || !navigator.permissions.query) return;
      try {
        const status = await navigator.permissions.query({ name: 'camera' });
        // state: 'granted' | 'prompt' | 'denied'
        console.log('Permission camera:', status.state);
      } catch (e) {
        // Beberapa browser tidak mengizinkan query('camera')
      }
    }

    // Event listeners
    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    snapBtn.addEventListener('click', takePhoto);
    refreshBtn.addEventListener('click', loadCameras);

    // Inisialisasi
    (async function init() {
      await checkPermission();
      await loadCameras();
    })();

    // Update daftar devices jika berubah (colok/lepas kamera)
    if (navigator.mediaDevices && navigator.mediaDevices.addEventListener) {
      navigator.mediaDevices.addEventListener('devicechange', loadCameras);
    }
  </script>
</body>
</html>
