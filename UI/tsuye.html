<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Timesheet Dashboard</title>
  <style>
    :root {
      --primary-color: #3d4ff5;
      --primary-dark: #97aff3;
      --success-color: #10b981;
      --success-dark: #0aca8d;
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --border-radius: 0.5rem;
      --transition: all 0.2s ease-in-out;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
      color: var(--gray-800);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 1rem;
    }

    .header {
      background: white;
      padding: 2rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
      border: 1px solid var(--gray-200);
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1rem;
    }

    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .filter-group label {
      font-weight: 600;
      color: var(--gray-700);
      font-size: 0.875rem;
    }

    .search-input,
    .date-input {
      padding: 0.55rem 1rem;
      border: 2px solid var(--gray-200);
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
      background: white;
    }

    .search-input:focus,
    .date-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
    }

    .filter-actions {
      display: flex;
      gap: 1rem;
      align-items: end;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--border-radius);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--gray-500);
      color: white;
    }

    .btn-secondary:hover {
      background: var(--gray-600);
    }

    .stats {
      display: flex;
      gap: 1rem;
      padding: 1rem 0;
      border-top: 1px solid var(--gray-200);
    }

    .stat-card {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      padding: 1rem;
      border-radius: var(--border-radius);
      flex: 1;
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 800;
    }

    .stat-label {
      font-size: 0.875rem;
      opacity: 0.9;
    }

    .table-container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid var(--gray-200);
    }

    .table-wrapper {
      overflow-x: hidden;
      max-height: 60vh; 
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    th {
      background: linear-gradient(135deg, var(--gray-800), var(--gray-700));
      color: white;
      padding: 1rem 0.75rem;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 1px solid var(--gray-600);
    }

    .parent-row {
      background: linear-gradient(135deg, var(--gray-50), white);
      font-weight: 600;
      border-left: 4px solid var(--primary-color);
      cursor: pointer;
      transition: var(--transition);
    }

    .parent-row:hover {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      transform: scale(1.002);
    }

    .parent-row.expanded {
      background: linear-gradient(135deg, var(--success-color), var(--success-dark));
      color: white;
    }

    .child-row {
      background: white;
      border-left: 4px solid var(--gray-200);
      transition: var(--transition);
      transform-origin: top;
    }

    .child-row:hover {
      background: var(--gray-50);
      cursor: pointer;
    }

    .child-row.validated {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
      border-left-color: var(--success-color);
    }

    .child-row.hide {
      display: none;
    }

    .child-row.show {
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: scaleY(0);
      }

      to {
        opacity: 1;
        transform: scaleY(1);
      }
    }

    td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--gray-200);
      vertical-align: middle;
    }

    .expand-icon {
      display: inline-block;
      transition: transform 0.3s ease;
      margin-right: 0.5rem;
      font-size: 1.2em;
    }

    .expand-icon.expanded {
      transform: rotate(90deg);
    }

    .validate-btn {
      padding: 0.375rem 0.75rem;
      background: var(--success-color);
      color: white;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
      transition: var(--transition);
    }

    .validate-btn:hover {
      background: var(--success-dark);
      transform: scale(1.05);
    }

    .validate-btn:disabled {
      background: var(--gray-300);
      cursor: not-allowed;
      transform: none;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
      color: var(--gray-500);
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--gray-200);
      border-top: 2px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .no-data {
      text-align: center;
      padding: 3rem;
      color: var(--gray-500);
    }

    .status-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-validated {
      background: var(--success-color);
      color: white;
    }

    .status-pending {
      background: var(--warning-color);
      color: white;
    }

    @media (max-width: 768px) {
      .container {
        padding: 0.5rem;
      }

      .header {
        padding: 1rem;
      }

      .header h1 {
        font-size: 1.75rem;
      }

      .filters {
        grid-template-columns: 1fr;
      }

      .filter-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .stats {
        flex-direction: column;
      }

      th,
      td {
        padding: 0.5rem;
        font-size: 0.75rem;
      }

      .table-wrapper {
        max-height: 60vh;
      }
    }

    .duration-cell {
      font-weight: 600;
      color: var(--primary-color);
    }

    .datetime-cell {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.8rem;
    }

    .op-text {
  font-weight: 600;
}

.op-note {
  margin-top: 6px;
  padding: 6px 8px;
  font-size: 0.75rem;
  font-style: italic;
  color: var(--gray-700);

  background: var(--gray-100);   /* background tipis */
  border-left: 3px solid var(--primary-color);
  border-radius: 4px;

  white-space: normal;
  word-break: break-word;
  line-height: 1.4;
}

  </style>
</head>

<body>
  <div class="container">
    <div class="header">


      <div class="filters">
        <div class="filter-group">
          <label>üîç Search (Serial, Name, Workcenter, Order)</label>
          <input type="text" id="searchInput" class="search-input" placeholder="Type to search...">
        </div>

        <div class="filter-group">
          <label>üìÖ Start Date</label>
          <input type="date" id="startDate" class="date-input">
        </div>

        <div class="filter-group">
          <label>üìÖ End Date</label>
          <input type="date" id="endDate" class="date-input">
        </div>

        <div class="filter-actions">
          <button id="filterBtn" class="btn btn-primary">
            üîç Filter
          </button>
          <button id="resetBtn" class="btn btn-secondary">
            üîÑ Reset
          </button>
        </div>
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="totalHours">0.0</div>
          <div class="stat-label">Total Hours</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalRecords">0</div>
          <div class="stat-label">Records</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalGroups">0</div>
          <div class="stat-label">Employees</div>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-wrapper">
        <table id="timesheetTable">
          <thead>
            <tr>
              <th>Serial Number</th>
              <th>Full Name</th>
              <th>Production Order</th>
              <th>SSBR Ident</th>
              <th>Operation Text</th>
              <th>Seq</th>
              <th>Check In</th>
              <th>Check Out</th>
              <th>Duration</th>
              <th>Workcenter</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="12" class="loading">
                <div class="spinner"></div>
                Loading timesheet data...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let allData = [];
    let filteredData = [];
    let groupedData = {};
    let expandedGroups = new Set();

    // ========================================
    // URL & SCROLL STATE MANAGEMENT
    // ========================================

    function loadFilterStateFromURL() {
      const params = new URLSearchParams(window.location.search);

      const startDate = params.get('startDate');
      const endDate = params.get('endDate');
      const search = params.get('search');
      const expanded = params.get('expanded');
      const scrollY = params.get('scrollY');

      if (startDate) document.getElementById('startDate').value = startDate;
      if (endDate) document.getElementById('endDate').value = endDate;
      if (search) document.getElementById('searchInput').value = search;
      if (expanded) {
        expanded.split(',').forEach(serial => expandedGroups.add(serial));
      }

      return { startDate, endDate, search, scrollY };
    }

    function saveFilterStateToURL() {
  // PERBAIKAN: Gunakan parameter yang sudah ada di URL
  const params = new URLSearchParams(window.location.search);

  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const search = document.getElementById('searchInput').value;

  if (startDate) params.set('startDate', startDate);
  else params.delete('startDate');

  if (endDate) params.set('endDate', endDate);
  else params.delete('endDate');

  if (search) params.set('search', search);
  else params.delete('search');

  if (expandedGroups.size > 0) {
    params.set('expanded', Array.from(expandedGroups).join(','));
  } else {
    params.delete('expanded');
  }

  // PERBAIKAN: Pastikan scrollY selalu diupdate dengan nilai current
  const currentScrollY = Math.round(window.scrollY);
  params.set('scrollY', currentScrollY.toString());

  const newURL = `${window.location.pathname}?${params.toString()}`;
  window.history.replaceState({}, '', newURL);
  
  console.log('Scroll saved:', currentScrollY); // Untuk debugging
}

    function restoreScrollPosition(scrollY) {
      if (!scrollY || scrollY === '0') return;
      
      const targetScroll = parseInt(scrollY);
      
      // PERBAIKAN: Gunakan DOMContentLoaded atau setTimeout untuk memastikan
      // tabel sudah dirender sepenuhnya
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(() => {
            window.scrollTo({
              top: targetScroll,
              behavior: 'auto'
            });
          }, 300);
        });
      } else {
        setTimeout(() => {
          window.scrollTo({
            top: targetScroll,
            behavior: 'auto'
          });
        }, 300);
      }
    }

    // ========================================
    // DATA LOADING
    // ========================================

    async function loadTimesheets(startDate = '', endDate = '') {
      try {
        const filterState = loadFilterStateFromURL();
        const scrollY = filterState.scrollY;

        document.getElementById('tableBody').innerHTML = `
          <tr>
            <td colspan="12" class="loading">
              <div class="spinner"></div>
              Loading timesheet data...
            </td>
          </tr>
        `;

        let url = '/timesheet/';
        if (startDate && endDate) {
          url = `/timesheet/search?field=longdate_checkin&start=${startDate}&end=${endDate}`;
        }

        const res = await fetch(url);
        const responseData = await res.json();

        let data;
        if (Array.isArray(responseData)) {
          data = responseData;
        } else if (responseData.data && Array.isArray(responseData.data)) {
          data = responseData.data;
        } else if (responseData.rows && Array.isArray(responseData.rows)) {
          data = responseData.rows;
        } else {
          throw new Error('Invalid response format from server');
        }

        allData = data;
        filteredData = data;

        const searchTerm = document.getElementById('searchInput').value;
        if (searchTerm) {
          applySearchFilter();
        } else {
          processData();
        }

        // PERBAIKAN: Simpan state dan restore scroll HANYA setelah data selesai dirender
        saveFilterStateToURL();
        
        // Restore scroll position setelah data selesai diproses
        if (scrollY) {
          restoreScrollPosition(scrollY);
        }

      } catch (err) {
        console.error('Error loading timesheets:', err);
        document.getElementById('tableBody').innerHTML = `
          <tr>
            <td colspan="12" class="no-data">
              ‚ùå Failed to load timesheet data: ${err.message}
            </td>
          </tr>
        `;
      }
    }

    // ========================================
    // DATA PROCESSING
    // ========================================

    function groupBySerial(data) {
      const grouped = {};
      data.forEach(item => {
        const serial = item.serialnumber || 'Unknown';
        if (!grouped[serial]) {
          grouped[serial] = [];
        }
        grouped[serial].push(item);
      });
      return grouped;
    }

    function calculateGroupSummary(children) {
      const totalDuration = children.reduce((sum, child) => {
        const duration = parseFloat(child.duration) || 0;
        return sum + duration;
      }, 0);

      const checkinTimes = children
        .map(child => child.longdate_checkin)
        .filter(Boolean)
        .map(time => new Date(time));

      const checkoutTimes = children
        .map(child => child.longdate_checkout)
        .filter(Boolean)
        .map(time => new Date(time));

      const minCheckin = checkinTimes.length ? new Date(Math.min(...checkinTimes)) : null;
      const maxCheckout = checkoutTimes.length ? new Date(Math.max(...checkoutTimes)) : null;

      return {
        serialNumber: children[0].serialnumber,
        fullName: children[0].full_name,
        totalDuration: totalDuration.toFixed(2),
        minCheckin: minCheckin,
        maxCheckout: maxCheckout,
        childCount: children.length
      };
    }

    function formatDateTime(dateTime) {
      if (!dateTime) return '';
      const d = new Date(dateTime);
      return d.toLocaleString('en-GB', {
        timeZone: 'Asia/Singapore',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      }).replace(',', '');
    }

    // ========================================
    // UI CREATION
    // ========================================

    function createParentRow(serial, summary, isExpanded) {
      const tr = document.createElement('tr');
      tr.className = `parent-row ${isExpanded ? 'expanded' : ''}`;
      tr.dataset.serial = serial;

      tr.innerHTML = `
        <td>
          <span class="expand-icon ${isExpanded ? 'expanded' : ''}">‚ñ∂</span>
          ${summary.serialNumber}
        </td>
        <td>${summary.fullName || ''}</td>
        <td colspan="4">
          <span style="opacity: 0.7; font-size: 0.8em;">
            ${summary.childCount} Activity
          </span>
        </td>
        <td class="datetime-cell">${formatDateTime(summary.minCheckin)}</td>
        <td class="datetime-cell">${formatDateTime(summary.maxCheckout)}</td>
        <td class="duration-cell">${summary.totalDuration}</td>
        <td colspan="2"></td>
        <td>
          <button class="validate-btn" onclick="validateGroup('${serial}')">
            ‚úì Group
          </button>
        </td>
      `;

      tr.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') {
          toggleGroup(serial);
        }
      });

      return tr;
    }

    function createChildRow(item, isVisible) {
      const tr = document.createElement('tr');
      const isValidated = !!item.validation_date;

      tr.className = `child-row ${isValidated ? 'validated' : ''} ${isVisible ? 'show' : 'hide'}`;
      tr.dataset.tsnumber = item.tsnumber;
      tr.dataset.serial = item.serialnumber;

      tr.innerHTML = `
        <td style="padding-left: 2rem;">${item.serialnumber || ''}</td>
        <td>${item.full_name || ''}</td>
        <td>${item.production_order || ''}</td>
        <td>${item.ssbr_ident || ''}</td>
        <td>
  <div class="op-text">${item.operation_text || ''}</div>
  ${item.note ? `<div class="op-note">${item.note}</div>` : ''}
</td>

        <td>${item.seq || ''}</td>
        <td class="datetime-cell">${item.date_checkin || ''} ${item.hour_checkin || ''}</td>
        <td class="datetime-cell">${item.date_checkout || ''} ${item.hour_checkout || ''}</td>
        <td class="duration-cell">${item.duration || '0'}</td>
        <td>${item.workcentercode || ''}</td>
        <td>
          ${isValidated
            ? '<span class="status-badge status-validated">‚úì Validated</span>'
            : '<span class="status-badge status-pending">‚è≥ Pending</span>'
          }
        </td>
        <td>
          <button class="validate-btn" data-tsnumber="${item.tsnumber}" ${isValidated ? 'disabled' : ''}>
            ‚úì
          </button>
        </td>
      `;

      if (!isValidated) {
        const validateBtn = tr.querySelector('.validate-btn');
        validateBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          validateSingle(item.tsnumber);
        });

        tr.addEventListener('click', (e) => {
          if (e.target.tagName !== 'BUTTON' && !e.target.closest('button')) {
            saveFilterStateToURL();
            const currentURL = window.location.href;
            window.location.href = `tsuyeedit?id=${item.tsnumber}&returnUrl=${encodeURIComponent(currentURL)}`;
          }
        });
      }

      return tr;
    }

    // ========================================
    // UI INTERACTIONS
    // ========================================

    function toggleGroup(serial) {
      const isExpanded = expandedGroups.has(serial);
      const parentRow = document.querySelector(`[data-serial="${serial}"].parent-row`);
      const childRows = document.querySelectorAll(`[data-serial="${serial}"].child-row`);
      const expandIcon = parentRow.querySelector('.expand-icon');

      if (isExpanded) {
        expandedGroups.delete(serial);
        parentRow.classList.remove('expanded');
        expandIcon.classList.remove('expanded');
        childRows.forEach(row => {
          row.classList.remove('show');
          row.classList.add('hide');
        });
      } else {
        expandedGroups.add(serial);
        parentRow.classList.add('expanded');
        expandIcon.classList.add('expanded');
        childRows.forEach(row => {
          row.classList.remove('hide');
          row.classList.add('show');
        });
      }

      saveFilterStateToURL();
    }

    function processData() {
      groupedData = groupBySerial(filteredData);
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      if (filteredData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="12" class="no-data">
              üì≠ No timesheet data found. Try adjusting your filters.
            </td>
          </tr>
        `;
        updateStats();
        return;
      }

      Object.entries(groupedData).forEach(([serial, children]) => {
        const summary = calculateGroupSummary(children);
        const isExpanded = expandedGroups.has(serial);
        tbody.appendChild(createParentRow(serial, summary, isExpanded));
        children.forEach(child => {
          tbody.appendChild(createChildRow(child, isExpanded));
        });
      });

      updateStats();
    }

    function updateStats() {
      const totalHours = filteredData.reduce((sum, item) => {
        return sum + (parseFloat(item.duration) || 0);
      }, 0);

      document.getElementById('totalHours').textContent = totalHours.toFixed(1);
      document.getElementById('totalRecords').textContent = filteredData.length;
      document.getElementById('totalGroups').textContent = Object.keys(groupedData).length;
    }

    function applySearchFilter() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();

      if (!searchTerm) {
        filteredData = [...allData];
      } else {
        filteredData = allData.filter(item => {
          return (
            (item.serialnumber || '').toLowerCase().includes(searchTerm) ||
            (item.full_name || '').toLowerCase().includes(searchTerm) ||
            (item.workcentercode || '').toLowerCase().includes(searchTerm) ||
            (item.production_order || '').toLowerCase().includes(searchTerm)
          );
        });
      }

      processData();
    }

    // ========================================
    // VALIDATION
    // ========================================

    function updateUIAfterValidation(tsnumbers) {
      tsnumbers.forEach(tsnumber => {
        const item = allData.find(d => d.tsnumber === tsnumber);
        if (item) {
          item.validation_date = new Date().toISOString();
          item.tsstatus = 'V';
        }

        const row = document.querySelector(`tr.child-row[data-tsnumber="${tsnumber}"]`);
        if (row) {
          row.classList.add('validated');

          const statusTd = row.querySelector('td:nth-child(11)');
          if (statusTd) {
            statusTd.innerHTML = '<span class="status-badge status-validated">‚úì Validated</span>';
          }

          const validateBtn = row.querySelector('.validate-btn');
          if (validateBtn) {
            validateBtn.disabled = true;
            validateBtn.textContent = '‚úì';
            validateBtn.style.opacity = '0.5';
          }

          row.style.cursor = 'default';
          row.onclick = null;
        }
      });

      updateGroupSummaries(tsnumbers);
    }

    function updateGroupSummaries(tsnumbers) {
      const affectedSerials = new Set();

      tsnumbers.forEach(tsnumber => {
        const item = allData.find(d => d.tsnumber === tsnumber);
        if (item) {
          affectedSerials.add(item.serialnumber);
        }
      });

      affectedSerials.forEach(serial => {
        const groupData = groupedData[serial];
        if (!groupData) return;

        const allValidated = groupData.every(item => item.validation_date);
        const parentRow = document.querySelector(`tr.parent-row[data-serial="${serial}"]`);
        const groupBtn = parentRow?.querySelector('.validate-btn');

        if (groupBtn && allValidated) {
          groupBtn.disabled = true;
          groupBtn.textContent = '‚úì All Validated';
          groupBtn.style.opacity = '0.5';
        }
      });
    }

    async function validateSingle(tsnumber) {
      const row = document.querySelector(`tr.child-row[data-tsnumber="${tsnumber}"]`);
      const btn = row?.querySelector('.validate-btn');

      if (!btn) return;

      const item = allData.find(d => d.tsnumber === tsnumber);
      if (!item) return;

      if (!item.longdate_checkout || !item.date_checkout || !item.hour_checkout) {
        alert('‚ö†Ô∏è Cannot validate: Checkout time is empty!\n\nPlease complete the checkout time first.');
        return;
      }

      const originalText = btn.textContent;

      try {
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner" style="width: 12px; height: 12px; margin: 0;"></div>';

        await fetch('/timesheet/validation', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tsnumbers: [tsnumber] })
        });

        updateUIAfterValidation([tsnumber]);

      } catch (err) {
        console.error('Validation error:', err);
        alert('Failed to validate record');
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function validateGroup(serial) {
      const parentRow = document.querySelector(`tr.parent-row[data-serial="${serial}"]`);
      const btn = parentRow?.querySelector('.validate-btn');

      if (!btn) return;

      const groupData = groupedData[serial];
      if (!groupData) return;

      const validatableItems = groupData.filter(item =>
        (item.longdate_checkout && item.date_checkout && item.hour_checkout) &&
        !item.validation_date
      );

      if (validatableItems.length === 0) {
        alert('‚ö†Ô∏è No records to validate!\n\nAll records are either incomplete or already validated.');
        return;
      }

      const incompleteCount = groupData.filter(item =>
        !item.longdate_checkout || !item.date_checkout || !item.hour_checkout
      ).length;

      const alreadyValidatedCount = groupData.filter(item => item.validation_date).length;

      let message = `Ready to validate ${validatableItems.length} record(s)`;
      if (incompleteCount > 0) {
        message += `\n\n‚ö†Ô∏è ${incompleteCount} record(s) will be skipped (incomplete checkout)`;
      }
      if (alreadyValidatedCount > 0) {
        message += `\n‚úì ${alreadyValidatedCount} record(s) already validated`;
      }

      if (!confirm(message + '\n\nContinue?')) {
        return;
      }

      const originalText = btn.textContent;

      try {
        const tsnumbers = validatableItems.map(item => item.tsnumber);

        btn.disabled = true;
        btn.innerHTML = '<div class="spinner" style="width: 12px; height: 12px; margin: 0;"></div>';

        const response = await fetch('/timesheet/validation', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tsnumbers })
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(error.error || `HTTP ${response.status}`);
        }

        const result = await response.json();
        updateUIAfterValidation(tsnumbers);

        btn.textContent = '‚úì Done';
        btn.style.background = '#10b981';

        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '';
          btn.disabled = false;
        }, 1000);

      } catch (err) {
        console.error('Group validation error:', err);
        alert(`‚ùå Failed to validate group: ${err.message}`);
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    // ========================================
    // EVENT LISTENERS
    // ========================================

    document.getElementById('searchInput').addEventListener('input', () => {
      applySearchFilter();
      saveFilterStateToURL();
    });

    document.getElementById('filterBtn').addEventListener('click', () => {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      if (startDate && endDate) {
        loadTimesheets(`${startDate} 00:00:00`, `${endDate} 23:59:59`);
      } else {
        loadTimesheets();
      }
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      document.getElementById('searchInput').value = '';
      expandedGroups.clear();
      window.history.replaceState({}, '', window.location.pathname);
      loadTimesheets();
    });

    let isPageInitialized = false;

    window.addEventListener('scroll', () => {
  // Jangan simpan scroll selama initial load
  if (!isPageInitialized) return;
  
  clearTimeout(scrollTimeout);
  scrollTimeout = setTimeout(() => {
    saveFilterStateToURL();
  }, 200);
});

    // ========================================
    // GLOBAL FUNCTIONS
    // ========================================

    window.validateSingle = validateSingle;
    window.validateGroup = validateGroup;

    // ========================================
    // INITIALIZATION
    // ========================================

    const filterState = loadFilterStateFromURL();

    // Inisialisasi dengan delay untuk memastikan DOM siap
    setTimeout(() => {
      if (filterState.startDate && filterState.endDate) {
        loadTimesheets(`${filterState.startDate} 00:00:00`, `${filterState.endDate} 23:59:59`);
      } else {
        loadTimesheets();
      }
    }, 100);
</script>
</body>

</html>