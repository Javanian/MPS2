<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Timesheet List</title>
  <link rel="stylesheet" href="css/stylets.css">
</head>
<body>

<h2>Timesheet Data</h2>

<div class="filter-row">
  <label>Start Date: <input type="date" id="startDate"></label>
  <label>End Date:   <input type="date" id="endDate"></label>
  <button id="filterBtn" class="btn-primary">Filter</button>
  <button id="resetBtn" class="btn-secondary">Reset</button>
</div>

<div class="table-container">
  <table id="timesheetTable">
    <thead>
      <tr class="main-header">
        <th>Serial Number</th>
        <th>Full Name</th>
        <th>Production Order</th>
        <th>SSBR Ident</th>
        <th>Operation Text</th>
        <th>Seq</th>
        <th>Date In</th>
        <th>Date Out</th>
        <th>Hour In</th>
        <th>Hour Out</th>
        <th>Duration</th>
        <th>Workcenter</th>
        <th>Validation Date</th>
        <!-- tombol validate all -->
        <th><button id="validateAllBtn" class="validate-btn">âœ“ All</button></th>
      </tr>
      <tr class="filter-header">
        <th><input type="text" id="filterSerial" placeholder="Filter Serial"></th>
        <th><input type="text" id="filterName" placeholder="Filter Name"></th>
        <th colspan="12"></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
let allData = [];
let filteredData = [];

// load data
async function loadTimesheets(startDate = '', endDate = '') {
  try {
    let url = '/timesheet/';
    if (startDate && endDate) {
      url = `/timesheet/search?field=longdate_checkin&start=${startDate}&end=${endDate}`;
    }
    const res = await fetch(url);
    const data = await res.json();
    allData = data;
    filteredData = data;
    renderTable(filteredData);
  } catch (err) {
    console.error(err);
    alert('Failed to load timesheets');
  }
}

// render table
function renderTable(data) {
  const tbody = document.querySelector('#timesheetTable tbody');
  tbody.innerHTML = '';

  data.forEach(row => {
    const tr = document.createElement('tr');
     const isValidated = !!row.validation_date;
    if (isValidated) {
      tr.style.backgroundColor = '#d4edda'; // hijau muda
    }
    tr.addEventListener('click', () => {
      window.location.href = `timesheet_edit.html?id=${row.tsnumber}`;
    });

    [
      row.serialnumber,
      row.full_name,
      row.production_order,
      row.ssbr_ident,
      row.operation_text,
      row.seq,
      row.date_checkin,
      row.date_checkout,
      row.hour_checkin,
      row.hour_checkout,
      row.duration,
      row.workcentercode,
      row.validation_date
    ].forEach((text, idx) => {
      const td = document.createElement('td');

      // ðŸ‘‰ khusus kolom Validation Date (index ke-12)
      if (idx === 12 && text) {
        const d = new Date(text);
        td.textContent = d.toLocaleString('en-GB', {
          timeZone: 'Asia/Singapore',   // GMT+8
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        }).replace(',', '');             // contoh: "19/09/2025 11:16:57"
      } else {
        td.textContent = text ?? '';
      }

      tr.appendChild(td);
    });

    // tombol validate per baris
    const tdButton = document.createElement('td');
    const btnVal = document.createElement('button');
    btnVal.textContent = 'âœ“';
    btnVal.className = 'validate-btn';
    if (isValidated) {
      // âœ… disable tombol jika sudah divalidasi
      btnVal.disabled = true;
      btnVal.style.opacity = '0.6';
      btnVal.style.cursor = 'not-allowed';
    } else {
      // hanya aktif jika belum divalidasi
      btnVal.addEventListener('click', async (e) => {
        e.stopPropagation();
        await bulkValidate([row.tsnumber]);
      });}
    tdButton.appendChild(btnVal);
    tr.appendChild(tdButton);

    tbody.appendChild(tr);
  });
}

// filter input
function applyHeaderFilter() {
  const s = document.getElementById('filterSerial').value.toLowerCase();
  const n = document.getElementById('filterName').value.toLowerCase();

  filteredData = allData.filter(r =>
    (r.serialnumber || '').toLowerCase().includes(s) &&
    (r.full_name   || '').toLowerCase().includes(n)
  );
  renderTable(filteredData);
}

// validate array of tsnumbers
async function bulkValidate(ids) {
  if (!ids.length) {
    alert('Tidak ada data untuk divalidasi.');
    return;
  }
  try {
    await fetch('/timesheet/validation', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tsnumbers: ids })
    });
    alert(`${ids.length} baris berhasil divalidasi`);
    loadTimesheets();
  } catch (err) {
    console.error(err);
    alert('Terjadi kesalahan saat validasi.');
  }
}

// validate semua hasil filter
async function validateAllFiltered() {
  if (!filteredData.length) {
    alert('Tidak ada data yang terfilter untuk divalidasi.');
    return;
  }
  if (!confirm(`Validate ${filteredData.length} baris yang sedang difilter?`)) return;
  const ids = filteredData.map(r => r.tsnumber);
  await bulkValidate(ids);
}

// event listeners
document.getElementById('filterSerial').addEventListener('input', applyHeaderFilter);
document.getElementById('filterName').addEventListener('input', applyHeaderFilter);
document.getElementById('validateAllBtn').addEventListener('click', validateAllFiltered);

document.getElementById('filterBtn').onclick = () => {
  const s = document.getElementById('startDate').value;
  const e = document.getElementById('endDate').value;
  s && e ? loadTimesheets(`${s} 00:00:00`, `${e} 23:59:59`) : loadTimesheets();
};

document.getElementById('resetBtn').onclick = () => {
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  document.getElementById('filterSerial').value = '';
  document.getElementById('filterName').value = '';
  loadTimesheets();
};

// load awal
loadTimesheets();
</script>

</body>
</html>
