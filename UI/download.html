<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Export Timesheet</title>
</head>
<body>
  <h2>Export Timesheet by Date</h2>

  <div>
    <label for="field">Date Field:</label>
    <select id="field">
      <option value="longdate_checkout">longdate_checkout</option>
      <option value="longdate_checkin">longdate_checkin</option>
    </select>
  </div>

  <div>
    <label for="start">Start Date:</label>
    <input type="date" id="start" />
  </div>

  <div>
    <label for="end">End Date:</label>
    <input type="date" id="end" />
  </div>

  <div>
    <button id="btnExcel">Download Excel</button>
    <button id="btnCsv">Download CSV</button>
  </div>

  <script>
    function buildQuery() {
      const start = document.getElementById('start').value;
      const end   = document.getElementById('end').value;
      const field = document.getElementById('field').value;

      if (!start || !end) {
        alert('Isi Start Date dan End Date dulu.');
        return null;
      }
      if (start > end) {
        alert('Start Date tidak boleh lebih besar dari End Date.');
        return null;
      }

      const q = new URLSearchParams({ start, end, field });
      return q.toString();
    }

    async function download(url, filename) {
      try {
        const res = await fetch(url);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || res.statusText);
        }
        const blob = await res.blob();
        const a = document.createElement('a');
        const objectUrl = URL.createObjectURL(blob);
        a.href = objectUrl;
        a.download = filename || 'download';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(objectUrl);
      } catch (e) {
        alert('Gagal download: ' + e.message);
        console.error(e);
      }
    }

    document.getElementById('btnExcel').addEventListener('click', async () => {
      const qs = buildQuery();
      if (!qs) return;
      const params = new URLSearchParams(qs);
      const field = params.get('field');
      const start = params.get('start');
      const end   = params.get('end');
      const fname = `timesheet_${field}_${start}_to_${end}.xlsx`;

      await download(`/timesheet/getxlsx?${qs}`, fname);
    });

    document.getElementById('btnCsv').addEventListener('click', async () => {
      const qs = buildQuery();
      if (!qs) return;
      const params = new URLSearchParams(qs);
      const field = params.get('field');
      const start = params.get('start');
      const end   = params.get('end');
      const fname = `timesheet_${field}_${start}_to_${end}.csv`;

      await download(`/timesheet/getcsv?${qs}`, fname);
    });
  </script>
</body>
</html>
