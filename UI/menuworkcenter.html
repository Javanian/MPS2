<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Select Machine</title>
  <link rel="stylesheet" href="css/main.css">
</head>
<body>
  <div class="page-container">

    <!-- Header -->
    <header class="app-header flex-between">
      <button class="btn btn-secondary small" onclick="goToMenu()">Back</button>
      <h2>Select Machine</h2>
      
      <div class="switch-wrapper">
  <span id="wcModeLabel">Reguler</span>
  <label class="switch">
    <input type="checkbox" id="wcModeToggle">
    <span class="slider"></span>
  </label>
</div>

      <button class="btn btn-secondary small" onclick="loadMachines()">Refresh</button>
    </header>

    <!-- Search row -->
    <div class="search-row">
      <input type="text" id="searchInput" class="input-text" placeholder="Search Machine...">
    </div>

    <!-- Machine list -->
    <div class="gallery-container">
      <div id="gallerymesin" class="gallery"></div>
    </div>
  </div>

  <script>

     /* ===== WORKCENTER MODE (REGULER / OVERTIME) ===== */
  const wcModeToggle = document.getElementById("wcModeToggle");
  const wcModeLabel  = document.getElementById("wcModeLabel");

  let wcMode = sessionStorage.getItem("wcMode") || "reguler";

  function setWcMode(mode) {
    wcMode = mode;
    sessionStorage.setItem("wcMode", mode);
    wcModeLabel.textContent = mode === "overtime" ? "Overtime" : "Reguler";
  }

  wcModeToggle.checked = wcMode === "overtime";
  setWcMode(wcMode);

  wcModeToggle.addEventListener("change", () => {
    setWcMode(wcModeToggle.checked ? "overtime" : "reguler");
    renderMachines(datamesin); // ðŸ”¥ refresh card UI
  });

  
    function goToMenu() {
      window.location.href = "mainmenu";
    }

    let datamesin = [];

    async function loadMachines() {
      try {
        const res = await fetch(`/workcenter/`);
        datamesin = await res.json();
        renderMachines(datamesin);
      } catch (err) {
        console.error("Gagal load mesin:", err);
      }
    }

    function renderMachines(data) {
  const gallery = document.getElementById("gallerymesin");
  gallery.innerHTML = "";

  data.forEach(item => {

    // âœ… item SUDAH VALID DI SINI
    const workcenterText =
      wcMode === "overtime"
        ? item.workcenterot
        : item.workcenternew;

    const overtimeClass = wcMode === "overtime" ? "overtime" : "";
    const overtimeBadge = wcMode === "overtime"
      ? `<div class="ot-badge">OT</div>`
      : "";

    const card = document.createElement("div");
    card.className = `machine-card ${overtimeClass}`;
    card.dataset.machineid = item.machineid;
    card.dataset.machinename = item.workcenter_description;
    card.dataset.groupname = item.groupname;

    card.innerHTML = `
      ${overtimeBadge}
      <div class="title">${item.workcenter_description}</div>
      <div class="detail"><span class="label">ID:</span> <span class="value">${item.machineid}</span></div>
      <div class="detail"><span class="label">Group:</span> <span class="value">${item.groupname}</span></div>
      <div class="detail"><span class="label">Workcenter:</span> <span class="value">${workcenterText || "-"}</span></div>
    `;

    card.addEventListener("click", async () => {
      try {
        const datakaryawan = JSON.parse(sessionStorage.getItem("datakaryawan"));
        const nfcid = datakaryawan.nfcid;

        const selectedWorkcenter =
          wcMode === "overtime"
            ? item.workcenterot
            : item.workcenternew;

        if (wcMode === "overtime" && !item.workcenterot) {
          alert("Workcenter Overtime tidak tersedia");
          return;
        }

        const response = await fetch("/usernfc/update/", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            serialnumber: datakaryawan.snssb,
            machineid: item.machineid,
            machinename: item.workcenter_description,
            workcenter: selectedWorkcenter
          })
        });

        if (!response.ok) throw new Error("Gagal update mesin");

        const res = await fetch(`/usernfc/nfcid/${nfcid}`);
        if (res.ok) {
          const updatedUser = await res.json();
          sessionStorage.setItem("datakaryawan", JSON.stringify(updatedUser));
        }

        window.location.href = "mainmenu";
      } catch (err) {
        console.error(err);
        alert("Update mesin gagal: " + err.message);
      }
    });

    gallery.appendChild(card);
  });
}


    // Search filter
    document.getElementById("searchInput").addEventListener("input", function () {
      const keyword = this.value.toLowerCase();
      const filtered = datamesin.filter(item =>
        item.workcenter_description.toLowerCase().includes(keyword) ||
        item.machineid.toLowerCase().includes(keyword) ||
        item.groupname.toLowerCase().includes(keyword)
      );
      renderMachines(filtered);
    });

    // load pertama kali
    loadMachines();
  </script>
</body>
</html>
