<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Prod Start/Stop</title>
</head>
<body>
  <h1>Production nfcs</h1>

  <button id="prodstart">Prod Start</button>
  <button id="prodstop">Prod Stop</button>

  <p>Status: <span id="status">Idle</span></p>
  <p>ID NFC terbaca: <span id="nfcid">-</span></p>

  <script>
// ==================== KONFIG ====================
const API_BASE = "https://100.107.210.61:3001";

// ==================== ELEMENT ===================
const btnStart = document.getElementById("prodstart");
const btnStop  = document.getElementById("prodstop");
const statusEl = document.getElementById("status");
const nfcidEl  = document.getElementById("nfcid");

// ==================== BANTU =====================
function setStatus(msg) {
  statusEl.textContent = msg;
}
function getTextRecord(e) {
  const recs = e.message?.records || [];
  for (const r of recs) if (r.recordType === "text") {
    try { return new TextDecoder(r.encoding || "utf-8").decode(r.data); } catch {}
  }
  return "";
}
function extractNfcId(e) {
  if (e.serialNumber && e.serialNumber.trim()) return e.serialNumber.trim();
  return getTextRecord(e).trim();
}

// GET user data by NFC ID ${API_BASE}/
async function getUserByNfc(nfcid) {
  const res = await fetch(`/usernfc/nfcid/${nfcid}`);
  if (!res.ok) return null;
  const data = await res.json().catch(() => null);
  return data && Object.keys(data).length ? data : null;
}

// Call stopall API
async function stopAllByNfc(nfcid) {
  const res = await fetch(`${API_BASE}/usernfc/stopall/${nfcid}`);
  return res.ok;
}

// Scan NFC and handle logic depending on action ("start"|"stop")
async function handleScan(action) {
  if (!("NDEFReader" in window)) {
    setStatus("Web NFC tidak didukung di browser ini");
    return;
  }
  try {
    const reader = new NDEFReader();
    await reader.scan();
    setStatus("Scanning... tempelkan tag NFC");

    reader.onreading = async (event) => {
      const nfcid = extractNfcId(event);
      nfcidEl.textContent = nfcid || "-";
      if (!nfcid) { setStatus("ID NFC kosong"); return; }

      const user = await getUserByNfc(nfcid);
      if (!user) {
        setStatus("user tidak ditemukan");
        return;
      }

      if (action === "start") {
        sessionStorage.setItem("datakaryawan", JSON.stringify(user));
        setStatus("User ditemukan, pindah ke mainmenu...");
        window.location.href = "mainmenu.html";
      } else if (action === "stop") {
        const ok = await stopAllByNfc(nfcid);
        if (ok) setStatus("berhasil stop semua timesheet");
        else    setStatus("gagal stop timesheet");
      }
    };

    reader.onreadingerror = () => setStatus("Gagal membaca NFC");
  } catch (err) {
    setStatus("Tidak bisa mulai scan: " + err.message);
  }
}

// ==================== EVENT =====================
btnStart.addEventListener("click", () => handleScan("start"));
btnStop.addEventListener("click", () => handleScan("stop"));

  </script>
</body>
</html>
