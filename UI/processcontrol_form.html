<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Process Control UI</title>
<link rel="stylesheet" href="../css/style.css" />
<link rel="stylesheet" href="../css/pss.css" />
</head>
<body>
<div class="container-wrapper">
  <!-- Container 1 -->
  <div class="container-wrapper" style="overflow:hidden;flex-direction: column;max-width:50%">
    <div class="containerjudul" style="overflow:visible;flex-direction: column;">
      <button id="btnCreates" onclick="goToMenu()"style="height:100%;width:100px">Back</button>
    <label>Process Category</label>
    <select id="categorySelect" style="height:100%"></select>
    </div>
    <div class="container" 
    style="overflow:auto;height: 100%;position:relative; padding:0px">
    <table id="timesheetTable">
      <thead>
        <tr>
          <th>Production Order</th>
          <th>SSBR Ident</th>
          <th>Operation Text</th>
          <th>Seq</th>
          <th>Workcenter Code</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    </div>
  </div>

  <!-- Container 2 -->
  <div class="container-wrapper" style="overflow:hidden;flex-direction: column;min-width:50%">
    <div class="containerjudul">
    <button id="btnCreate" style="height:100%;width:100px">Create</button>
    <button id="btnCreate"  onclick="gotoedit()"style="height:100%;width:100px">Edit</button>
    </div>
    <div class="container" style="overflow:auto;height: 100%;">
    <form id="parameterForm"></form>
    <button id="btnSubmit" style="margin-top:10px;">Submits Data</button>
    </div>
  </div>
</div>

<script>

function goToMenu() {window.location.href = "mainmenu";};
function gotoedit() {window.location.href = "editparameter";}
const datakaryawan = JSON.parse(sessionStorage.getItem("datakaryawan"));
const serialnumber = datakaryawan.snssb;
const categorySelect = document.getElementById('categorySelect');
const timesheetBody = document.querySelector('#timesheetTable tbody');
const parameterForm = document.getElementById('parameterForm');

async function loadCategories() {
  const res = await fetch(`/process-category`);
  const data = await res.json();
  categorySelect.innerHTML = data.map(c =>
    `<option value="${c.id_process}">${c.process_name}</option>`).join('');
}


async function loadTimesheet() {
  const res = await fetch(`/timesheet/getsn/${serialnumber}`);
  const data = await res.json();
  timesheetBody.innerHTML = data.map(row =>
    `<tr>
      <td>${row.production_order}</td>
      <td>${row.ssbr_ident}</td>
      <td>${row.operation_text}</td>
      <td>${row.seq}</td>
      <td>${row.workcentercode}</td>
    </tr>`).join('');
}

timesheetBody.addEventListener('click', e => {
  const tr = e.target.closest('tr');
  if (!tr) return;
  timesheetBody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
  tr.classList.add('selected');

  const cells = Array.from(tr.children).map(td => td.textContent);
  sessionStorage.setItem("datatimepcs", JSON.stringify({
    production_order: cells[0],
    ssbr_ident: cells[1],
    operation_text: cells[2],
    seq: cells[3],
    workcentercode: cells[4]
  }));
});

document.getElementById('btnCreate').addEventListener('click', async () => {
  parameterForm.innerHTML = '';
  const id_process = categorySelect.value;
  if (!id_process) return alert('Pilih kategori proses dulu');

  const res = await fetch(`/process-parameter?process=${id_process}`);
  const parameters = await res.json();

  for (const p of parameters) {
    const row = document.createElement('div');
    row.className = 'form-row';

    const label = document.createElement('label');
    label.textContent = p.parameter_name;
    row.appendChild(label);
    row.dataset.isnumber = p.isnumber;
    row.dataset.ischoice = p.ischoice;
    const inputBox = document.createElement('div');
    inputBox.className = 'input-box';

    let mainInput;

    if (p.ischoice) {
      mainInput = document.createElement('select');
      mainInput.name = `param_${p.id_parameter}`;
      const chRes = await fetch(`/process-parameter-choicebase?parameter=${p.id_parameter}`);
      const choices = await chRes.json();
      mainInput.innerHTML = choices.map(c => `<option value="${c.choice_name}">${c.choice_name}</option>`).join('')
                          + `<option value="Other">Other</option>`;

      // Other text box hidden initially
      const otherInput = document.createElement('input');
      otherInput.type = 'text';
      otherInput.placeholder = 'Other...';
      otherInput.className = 'other-input';
      otherInput.name = `other_${p.id_parameter}`;
      inputBox.appendChild(mainInput);
      inputBox.appendChild(otherInput);

      mainInput.addEventListener('change', () => {
        otherInput.style.display = mainInput.value === 'Other' ? 'inline-block' : 'none';
      });
    } else if (p.isnumber) {
      mainInput = document.createElement('input');
      mainInput.type = 'number';
      mainInput.name = `param_${p.id_parameter}`;
      inputBox.appendChild(mainInput);
    } else {
      mainInput = document.createElement('input');
      mainInput.type = 'text';
      mainInput.name = `param_${p.id_parameter}`;
      inputBox.appendChild(mainInput);
    }

    const uomLabel = document.createElement('div');
    uomLabel.className = 'uom-label';
    uomLabel.textContent = p.uom || '';

    row.appendChild(inputBox);
    row.appendChild(uomLabel);
    parameterForm.appendChild(row);
  }
});

document.getElementById('btnSubmit').addEventListener('click', async (e) => {
  e.preventDefault();
  const selectedRow = timesheetBody.querySelector('tr.selected');
  if (!selectedRow) return alert('Pilih baris timesheet dulu');

  const cells = selectedRow.children;
  const production_order = cells[0].textContent;
  const ssbr_ident = cells[1].textContent;
  const operation_text = cells[2].textContent;
  const seq = cells[3].textContent;
  const workcentercode = cells[4].textContent;

  const controlRes = await fetch('/process-control', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      production_order,
      ssbr_id: ssbr_ident,
      operation_text,
      full_name: datakaryawan.full_name,
      snssb:datakaryawan.snssb,
      operation_no: seq,
      workcenter: workcentercode
    })
  });
  const controlData = await controlRes.json();
  const newId = controlData.id_processcontroldata;

  for (const row of parameterForm.querySelectorAll('.form-row')) {
    const selectEl = row.querySelector('select');
    const mainInput = selectEl || row.querySelector('input[type="text"], input[type="number"]');
    const otherEl = row.querySelector('.other-input');
    const uom = row.querySelector('.uom-label').textContent;
    const isnumber = row.dataset.isnumber; // konversi ke boolean
    const ischoice = row.dataset.ischoice;
    let value, id_parameter;

    if (selectEl) {
      id_parameter = selectEl.name.split('_')[1];
      value = selectEl.value === 'Other' ? (otherEl.value || '') : selectEl.value;
    } else {
      id_parameter = mainInput.name.split('_')[1];
      value = mainInput.value;
    }

    await fetch('/process-control-item', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        category_name: categorySelect.options[categorySelect.selectedIndex].text,
        parameter_name: row.querySelector('label').textContent,
        value,
        uom,
        isnumber,          
        ischoice, 
        id_parameter,
        id_processcontroldata: newId
      })
    });
  }
  alert('Data berhasil disimpan');
});

timesheetBody.addEventListener('click', e => {
  const tr = e.target.closest('tr');
  if (!tr) return;
  timesheetBody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
  tr.classList.add('selected');
});

loadCategories();
loadTimesheet();
</script>


</body>
</html>
