<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Process Control Data</title>
<link rel="stylesheet" href="../css/style.css" />
<link rel="stylesheet" href="../css/pss.css" />
</head>
<body>
<div class="container-wrapper">

  <!-- LEFT side -->
  <div class="container-wrapper" style="overflow:hidden;flex-direction: column;max-width:50%">
    <div class="containerjudul" style="overflow:visible;">
      <button id="btn" onclick="gotoinput()">Back</button>
      <button id="btnBySN">BySN</button>
      <button id="btnByWCT">ByWCT</button>
    </div>

    <div class="container" style="overflow:auto;height:100%;position:relative;padding:0">
      <table id="processControlTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Production Order</th>
            <th>Ident</th>
            <th>Workcenter</th>
            <th>Status</th>
            <th>Validator</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- RIGHT side -->
  <div class="container-wrapper" style="overflow:hidden;flex-direction: column;min-width:50%">
    <div class="containerjudul" id="rightHeader">
      <!-- Accept/Reject button injected by JS if roles == FOREMAN -->
    </div>
    <div class="container" style="overflow:auto;height:100%">
      <form id="processItemForm"></form>
      <button id="btnUpdateItem" style="margin-top:10px;">Update Items</button>
    </div>
  </div>

</div>

<script>
  function gotoinput() {window.location.href = "processcontrol_form";};
const datakaryawan = JSON.parse(sessionStorage.getItem("datakaryawan"));
const processTableBody = document.querySelector('#processControlTable tbody');
const processItemForm = document.getElementById('processItemForm');
let selectedProcessId = null;

// if foreman, show Accept/Reject
if (datakaryawan.roles === "FOREMAN") {
  const header = document.getElementById('rightHeader');
  header.innerHTML = `
    <button id="btnAccept">Accept</button>
    <button id="btnReject">Reject</button>
  `;
}

// load processcontroldata based on filter
async function loadProcessControlData(filterType) {
  let url;
  if (filterType === 'SN') url = `/process-control/by-sn/${datakaryawan.snssb}`;
  else if (filterType === 'WCT') url = `/process-control/by-wct/${datakaryawan.workcenter}`;
  else return;

  const res = await fetch(url);
  const data = await res.json();

  processTableBody.innerHTML = data.map(row => `
    <tr data-id="${row.id_processcontroldata}">
      <td>${row.id_processcontroldata}</td>
      <td>${row.full_name}</td>
      <td>${row.production_order}</td>
      <td>${row.ssbr_id}</td>
      <td>${row.workcenter}</td>
      <td>${row.validation_status || ''}</td>
      <td>${row.validation_by || ''}</td>
    </tr>
  `).join('');
}

// click row â†’ load processcontroldata_item
processTableBody.addEventListener('click', async e => {
  const tr = e.target.closest('tr');
  if (!tr) return;
  processTableBody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
  tr.classList.add('selected');

  selectedProcessId = tr.dataset.id;

  const res = await fetch(`/process-control-item/${selectedProcessId}`);
  const items = await res.json();

  processItemForm.innerHTML = '';
  for (const p of items) {
    const row = document.createElement('div');
    row.className = 'form-row';
    row.dataset.id_parameter = p.id_parameter;
    row.dataset.isnumber = p.isnumber;
    row.dataset.ischoice = p.ischoice;

    const label = document.createElement('label');
    label.textContent = p.parameter_name;
    row.appendChild(label);

    const inputBox = document.createElement('div');
    inputBox.className = 'input-box';
    let mainInput;

    if (p.ischoice) {
      mainInput = document.createElement('select');
      mainInput.name = `param_${p.id_parameter}`;
      const chRes = await fetch(`/process-parameter-choicebase?parameter=${p.id_parameter}`);
      const choices = await chRes.json();
      mainInput.innerHTML = choices.map(c =>
        `<option value="${c.choice_name}">${c.choice_name}</option>`).join('')
        + `<option value="Other">Other</option>`;

      // set current value
      mainInput.value = choices.some(c => c.choice_name === p.value) ? p.value : 'Other';

      const otherInput = document.createElement('input');
      otherInput.type = 'text';
      otherInput.placeholder = 'Other...';
      otherInput.className = 'other-input';
      otherInput.name = `other_${p.id_parameter}`;
      otherInput.value = mainInput.value === 'Other' ? p.value : '';
      otherInput.style.display = mainInput.value === 'Other' ? 'inline-block' : 'none';

      mainInput.addEventListener('change', () => {
        otherInput.style.display = mainInput.value === 'Other' ? 'inline-block' : 'none';
      });

      inputBox.appendChild(mainInput);
      inputBox.appendChild(otherInput);

    } else if (p.isnumber) {
      mainInput = document.createElement('input');
      mainInput.type = 'number';
      mainInput.name = `param_${p.id_parameter}`;
      mainInput.value = p.value || '';
      inputBox.appendChild(mainInput);
    } else {
      mainInput = document.createElement('input');
      mainInput.type = 'text';
      mainInput.name = `param_${p.id_parameter}`;
      mainInput.value = p.value || '';
      inputBox.appendChild(mainInput);
    }

    const uomLabel = document.createElement('div');
    uomLabel.className = 'uom-label';
    uomLabel.textContent = p.uom || '';

    row.appendChild(inputBox);
    row.appendChild(uomLabel);
    processItemForm.appendChild(row);
  }
});

// update only processcontroldata_item values
document.getElementById('btnUpdateItem').addEventListener('click', async e => {
  e.preventDefault();
  if (!selectedProcessId) return alert('Pilih data process control dulu');

  for (const row of processItemForm.querySelectorAll('.form-row')) {
    const selectEl = row.querySelector('select');
    const otherEl = row.querySelector('.other-input');
    const mainInput = selectEl || row.querySelector('input[type="text"], input[type="number"]');
    const value = selectEl && selectEl.value === 'Other' ? (otherEl.value || '') : mainInput.value;

    await fetch(`/process-control-item/update/${selectedProcessId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id_parameter: row.dataset.id_parameter,
        value
      })
    });
  }
  alert('Items updated');
});

// Accept / Reject logic for foreman
if (datakaryawan.roles === "FOREMAN") {
  document.getElementById('btnAccept').addEventListener('click', () => updateValidation('Accept'));
  document.getElementById('btnReject').addEventListener('click', () => updateValidation('Reject'));
}

async function updateValidation(status) {
  if (!selectedProcessId) return alert('Pilih data process control dulu');

  await fetch(`/process-control/validate/${selectedProcessId}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      validation_by: datakaryawan.full_name,
      validation_status: status
    })
  });

  alert(`Process control ${status}`);
  // refresh table to reflect validation status
  processTableBody.querySelector(`tr.selected td:nth-child(6)`).textContent = status;
  processTableBody.querySelector(`tr.selected td:nth-child(7)`).textContent = datakaryawan.full_name;
}

// initial load
document.getElementById('btnBySN').addEventListener('click', () => loadProcessControlData('SN'));
document.getElementById('btnByWCT').addEventListener('click', () => loadProcessControlData('WCT'));
</script>
</body>
</html>
