<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit Timesheet</title>
  <link rel="stylesheet" href="../css/stylets.css">
  <style>
    .edit-container{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px;
      margin-top:20px;
      max-width:900px;
    }
    .form-section{
      background:#fff;
      padding:20px;
      border:1px solid #ccc;
      border-radius:8px;
    }
    .form-section h3{margin-top:0;}
    .form-group{
      display:flex;
      flex-direction:column;
      margin-bottom:12px;
    }
    .form-group label{font-weight:600;margin-bottom:6px;}
    .form-group input{
      padding:8px;
      border:1px solid #ccc;
      border-radius:6px;
      font-size:14px;
    }
    .btn-save{
      margin-top:20px;
      padding:12px 24px;
      background:#007bff;
      color:#fff;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-size:16px;
    }
    .btn-save:hover{background:#0056b3;}
  </style>
</head>
<body>

<h2>Edit Timesheet</h2>

<div class="edit-container">
  <!-- LEFT SIDE : General info -->
  <div class="form-section">
    <h3>General Info</h3>
    <div class="form-group">
      <label>Serial Number</label>
      <input type="text" id="serialnumber">
    </div>
    <div class="form-group">
      <label>Full Name</label>
      <input type="text" id="full_name">
    </div>
    <div class="form-group">
      <label>Production Order</label>
      <input type="text" id="production_order">
    </div>
    <div class="form-group">
      <label>SSBR Ident</label>
      <input type="text" id="ssbr_ident">
    </div>
    <div class="form-group">
      <label>Operation Text</label>
      <input type="text" id="operation_text">
    </div>
    <div class="form-group">
      <label>Seq</label>
      <input type="text" id="seq">
    </div>
    <div class="form-group">
      <label>Workcenter</label>
      <input type="text" id="workcentercode">
    </div>
  </div>

  <!-- RIGHT SIDE : Date & time -->
  <div class="form-section">
    <h3>Check-in / Check-out</h3>

    <div class="form-group">
      <label>Longdate Check-in (Date)</label>
      <input type="date" id="date_checkin_picker">
    </div>
    <div class="form-group">
      <label>Hour Check-in (Time)</label>
      <input type="time" id="hour_checkin_picker" step="60">
    </div>

    <div class="form-group">
      <label>Longdate Check-out (Date)</label>
      <input type="date" id="date_checkout_picker">
    </div>
    <div class="form-group">
      <label>Hour Check-out (Time)</label>
      <input type="time" id="hour_checkout_picker" step="60">
    </div>

  </div>
</div>
<button class="btn-save" id="backbtn" onclick="gomenu()">Back</button>
<button class="btn-save" id="saveBtn">Save Changes</button>

<script>
  function gomenu() {
      window.location.href = "timesheet_list.html";
    }
//const TZ = 'Asia/Jakarta';  // âœ… zona waktu GMT+8
const params = new URLSearchParams(window.location.search);
const id = params.get('id');

// helper: format tanggal untuk input type="date"
function toDateInputValue(isoOrDbString) {
  const d = new Date(isoOrDbString);
  return new Intl.DateTimeFormat('en-CA', { // YYYY-MM-DD
    //timeZone: TZ,
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  }).format(d);
}

// helper: format jam untuk input type="time"
function toTimeInputValue(isoOrDbString) {
  const d = new Date(isoOrDbString);
  return new Intl.DateTimeFormat('en-GB', { // HH:mm
    //timeZone: TZ,
    hour: '2-digit',
    minute: '2-digit',
    hour12: false
  }).format(d);
}

// helper: gabungkan date & time ke ISO dengan offset Asia/Singapore
function combineDateTime(date, time) {
  if (!date || !time) return null;
   return `${date}T${time}:00+08:00`;
}

async function loadRecord(){
  try{
    const res = await fetch(`/timesheet/getid/${id}`);
    const data = await res.json();
    if(!data) return alert('Data tidak ditemukan');

    // isi field kiri
    document.getElementById('serialnumber').value = data.serialnumber || '';
    document.getElementById('full_name').value = data.full_name || '';
    document.getElementById('production_order').value = data.production_order || '';
    document.getElementById('ssbr_ident').value = data.ssbr_ident || '';
    document.getElementById('operation_text').value = data.operation_text || '';
    document.getElementById('seq').value = data.seq || '';
    document.getElementById('workcentercode').value = data.workcentercode || '';

    // isi field kanan
    if (data.longdate_checkin) {
      document.getElementById('date_checkin_picker').value = toDateInputValue(data.longdate_checkin);
      document.getElementById('hour_checkin_picker').value = toTimeInputValue(data.longdate_checkin);
    }
    if (data.longdate_checkout) {
      document.getElementById('date_checkout_picker').value = toDateInputValue(data.longdate_checkout);
      document.getElementById('hour_checkout_picker').value = toTimeInputValue(data.longdate_checkout);
    }
  }catch(err){
    console.error(err);
    alert('Gagal load data');
  }
}

document.getElementById('saveBtn').addEventListener('click', async ()=>{
  try{
    const longdate_checkin = combineDateTime(
      document.getElementById('date_checkin_picker').value,
      document.getElementById('hour_checkin_picker').value
    );
    const longdate_checkout = combineDateTime(
      document.getElementById('date_checkout_picker').value,
      document.getElementById('hour_checkout_picker').value
    );

    const body = {
      serialnumber: document.getElementById('serialnumber').value,
      full_name: document.getElementById('full_name').value,
      production_order: document.getElementById('production_order').value,
      ssbr_ident: document.getElementById('ssbr_ident').value,
      operation_text: document.getElementById('operation_text').value,
      seq: document.getElementById('seq').value,
      workcentercode: document.getElementById('workcentercode').value,
      longdate_checkin,
      longdate_checkout
    };

    const res = await fetch(`/timesheet/updateadmin/${id}`, {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });

    if(!res.ok) throw new Error('Update gagal');
    alert('Timesheet berhasil diupdate');
    window.location.href='timesheet_list.html';
  }catch(err){
    console.error(err);
    alert(err.message);
  }
});

loadRecord();
</script>
</body>
</html>
