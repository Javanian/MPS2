<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Process Control UI</title>
<link rel="stylesheet" href="../css/processcontrol.css" />
<style>
/* Additional styles for search & pagination */
.table-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 15px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.search-box {
  flex: 1;
  min-width: 250px;
  position: relative;
}

.search-box input {
  width: 100%;
  height: 40px;
  padding: 0 40px 0 15px;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  font-size: 14px;
  transition: all 0.3s ease;
}

.search-box input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.search-box::after {
  content: "üîç";
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
}

.rows-per-page {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: #495057;
}

.rows-per-page select {
  height: 40px;
  padding: 0 30px 0 10px;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
  background: white;
}

.data-info {
  font-size: 13px;
  color: #6c757d;
  padding: 10px 0;
}

.pagination-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  margin-top: 20px;
  padding: 15px 0;
}

.page-btn {
  height: 36px;
  min-width: 36px;
  padding: 0 12px;
  border: 2px solid #e9ecef;
  background: white;
  border-radius: 6px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.page-btn:hover:not(:disabled) {
  border-color: #667eea;
  color: #667eea;
  transform: translateY(-2px);
}

.page-btn.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-color: transparent;
}

.page-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.page-dots {
  padding: 0 5px;
  color: #adb5bd;
}

.export-btn {
  height: 40px;
  padding: 0 15px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.export-btn:hover {
  background: #218838;
  transform: translateY(-2px);
}

@media (max-width: 768px) {
  .table-controls {
    flex-direction: column;
  }
  
  .search-box {
    width: 100%;
  }
  
  .pagination-wrapper {
    flex-wrap: wrap;
  }
  
  .page-btn {
    min-width: 32px;
    height: 32px;
    font-size: 12px;
  }
}
</style>
</head>
<body>
<div class="container-wrapper">
  <!-- Container 1 -->
  <div class="container-wrapper" style="overflow:hidden;flex-direction: column;max-width:50%">
    <div class="containerjudul" style="overflow:visible;flex-direction: column;">
      <button id="btnCreates" onclick="goToMenu()" style="height:100%;width:100px">Back</button>
      <label>Process Category</label>
      <select id="categorySelect" style="height:100%"></select>
    </div>
    
    <div class="container" style="overflow:visible;height: 100%;position:relative; padding:15px">
      <!-- Search & Controls -->
      <div class="table-controls">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Search production order, SSBR, operation..." oninput="handleSearchInput(event)">
        </div>
        <div class="rows-per-page">
          <label>Show:</label>
          <select onchange="changeRowsPerPage(this.value)">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        <button class="export-btn" onclick="exportToCSV()">üì• Export CSV</button>
      </div>
      
      <!-- Data Info -->
      <div class="data-info" id="dataInfo">Loading...</div>
      
      <!-- Table Container with Scroll -->
      <div style="overflow:auto; max-height: calc(100vh - 400px);">
        <table id="timesheetTable">
          <thead>
            <tr>
              <th>Production Order</th>
              <th>SSBR Ident</th>
              <th>Operation Text</th>
              <th>Seq</th>
              <th>Workcenter Code</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <div class="pagination-wrapper" id="paginationControls"></div>
    </div>
  </div>

  <!-- Container 2 -->
  <div class="container-wrapper" style="overflow:hidden;flex-direction: column;min-width:50%">
    <div class="containerjudul">
      <button id="btnCreate" style="height:100%;width:100px">Create</button>
      <button id="btnCreate" onclick="gotoedit()" style="height:100%;width:100px">Edit</button>
    </div>
    <div class="container" style="overflow:auto;height: 100%;">
      <form id="parameterForm"></form>
      <button id="btnSubmit" style="margin-top:10px;">Submit Data</button>
    </div>
  </div>
</div>

<script>
function goToMenu() {window.location.href = "mainmenu";}
function gotoedit() {window.location.href = "editparameter";}

const datakaryawan = JSON.parse(sessionStorage.getItem("datakaryawan"));
const serialnumber = datakaryawan.snssb;
const categorySelect = document.getElementById('categorySelect');
const timesheetBody = document.querySelector('#timesheetTable tbody');
const parameterForm = document.getElementById('parameterForm');

// ===== PAGINATION & SEARCH VARIABLES =====
let allTimesheetData = [];
let filteredData = [];
let currentPage = 1;
let rowsPerPage = 20;

// ===== LOAD CATEGORIES =====
async function loadCategories() {
  const res = await fetch(`/process-category`);
  const data = await res.json();
  categorySelect.innerHTML = data.map(c =>
    `<option value="${c.id_process}">${c.process_name}</option>`).join('');
}

// ===== LOAD DATA WITH PAGINATION =====
async function loadTimesheet() {
  try {
    const res = await fetch(`/timesheet/getsn/${serialnumber}`);
    allTimesheetData = await res.json();
    filteredData = [...allTimesheetData];
    
    updateDataInfo();
    renderTimesheet();
    renderPagination();
  } catch (error) {
    console.error('Error loading timesheet:', error);
    timesheetBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#dc3545;">Failed to load data</td></tr>';
  }
}

// ===== RENDER TABLE =====
function renderTimesheet() {
  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const pageData = filteredData.slice(start, end);
  
  if (pageData.length === 0) {
    timesheetBody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:#6c757d;">No data found</td></tr>';
    return;
  }
  
  timesheetBody.innerHTML = pageData.map((row, index) =>
    `<tr data-index="${start + index}">
      <td>${row.production_order}</td>
      <td>${row.ssbr_ident}</td>
      <td>${row.operation_text}</td>
      <td>${row.seq}</td>
      <td>${row.workcentercode}</td>
    </tr>`
  ).join('');
}

// ===== PAGINATION =====
function renderPagination() {
  const totalPages = Math.ceil(filteredData.length / rowsPerPage);
  const container = document.getElementById('paginationControls');
  if (!container) return;
  
  let html = `<button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Üê Prev</button>`;
  
  const maxVisible = 5;
  let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
  let endPage = Math.min(totalPages, startPage + maxVisible - 1);
  
  if (endPage - startPage < maxVisible - 1) {
    startPage = Math.max(1, endPage - maxVisible + 1);
  }
  
  if (startPage > 1) {
    html += `<button class="page-btn" onclick="changePage(1)">1</button>`;
    if (startPage > 2) html += `<span class="page-dots">...</span>`;
  }
  
  for (let i = startPage; i <= endPage; i++) {
    html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
  }
  
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) html += `<span class="page-dots">...</span>`;
    html += `<button class="page-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
  }
  
  html += `<button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next ‚Üí</button>`;
  
  container.innerHTML = html;
}

function changePage(page) {
  const totalPages = Math.ceil(filteredData.length / rowsPerPage);
  if (page < 1 || page > totalPages) return;
  currentPage = page;
  renderTimesheet();
  renderPagination();
  document.getElementById('timesheetTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ===== SEARCH =====
function searchTimesheet(query) {
  const searchLower = query.toLowerCase().trim();
  
  filteredData = searchLower === '' ? [...allTimesheetData] : 
    allTimesheetData.filter(row => 
      row.production_order.toLowerCase().includes(searchLower) ||
      row.ssbr_ident.toLowerCase().includes(searchLower) ||
      row.operation_text.toLowerCase().includes(searchLower) ||
      row.seq.toString().includes(searchLower) ||
      row.workcentercode.toLowerCase().includes(searchLower)
    );
  
  currentPage = 1;
  updateDataInfo();
  renderTimesheet();
  renderPagination();
}

let searchTimeout;
function handleSearchInput(e) {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => searchTimesheet(e.target.value), 300);
}

// ===== DATA INFO =====
function updateDataInfo() {
  const info = document.getElementById('dataInfo');
  if (!info) return;
  
  const start = Math.min((currentPage - 1) * rowsPerPage + 1, filteredData.length);
  const end = Math.min(currentPage * rowsPerPage, filteredData.length);
  
  info.innerHTML = `Showing <strong>${start}-${end}</strong> of <strong>${filteredData.length}</strong> records`;
  if (filteredData.length < allTimesheetData.length) {
    info.innerHTML += ` (filtered from <strong>${allTimesheetData.length}</strong> total)`;
  }
}

function changeRowsPerPage(value) {
  rowsPerPage = parseInt(value);
  currentPage = 1;
  renderTimesheet();
  renderPagination();
  updateDataInfo();
}

// ===== EXPORT CSV =====
function exportToCSV() {
  const headers = ['Production Order', 'SSBR Ident', 'Operation Text', 'Seq', 'Workcenter Code'];
  const csv = [
    headers.join(','),
    ...filteredData.map(r => [r.production_order, r.ssbr_ident, r.operation_text, r.seq, r.workcentercode].join(','))
  ].join('\n');
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `timesheet_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// ===== ROW SELECTION =====
timesheetBody.addEventListener('click', e => {
  const tr = e.target.closest('tr');
  if (!tr || !tr.dataset.index) return;
  
  timesheetBody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
  tr.classList.add('selected');
  
  const index = parseInt(tr.dataset.index);
  const rowData = filteredData[index];
  
  sessionStorage.setItem("datatimepcs", JSON.stringify({
    production_order: rowData.production_order,
    ssbr_ident: rowData.ssbr_ident,
    operation_text: rowData.operation_text,
    seq: rowData.seq,
    workcentercode: rowData.workcentercode
  }));
});

// ===== CREATE FORM (existing code) =====
document.getElementById('btnCreate').addEventListener('click', async () => {
  parameterForm.innerHTML = '';
  const id_process = categorySelect.value;
  if (!id_process) return alert('Pilih kategori proses dulu');

  const res = await fetch(`/process-parameter?process=${id_process}`);
  const parameters = await res.json();

  for (const p of parameters) {
    const row = document.createElement('div');
    row.className = 'form-row';
    row.dataset.isnumber = p.isnumber;
    row.dataset.ischoice = p.ischoice;

    const label = document.createElement('label');
    label.textContent = p.parameter_name;
    row.appendChild(label);

    const inputBox = document.createElement('div');
    inputBox.className = 'input-box';
    let mainInput;

    if (p.ischoice) {
      mainInput = document.createElement('select');
      mainInput.name = `param_${p.id_parameter}`;
      const chRes = await fetch(`/process-parameter-choicebase?parameter=${p.id_parameter}`);
      const choices = await chRes.json();
      mainInput.innerHTML = choices.map(c => `<option value="${c.choice_name}">${c.choice_name}</option>`).join('') + `<option value="Other">Other</option>`;

      const otherInput = document.createElement('input');
      otherInput.type = 'text';
      otherInput.placeholder = 'Other...';
      otherInput.className = 'other-input';
      otherInput.name = `other_${p.id_parameter}`;
      inputBox.appendChild(mainInput);
      inputBox.appendChild(otherInput);

      mainInput.addEventListener('change', () => {
        otherInput.style.display = mainInput.value === 'Other' ? 'inline-block' : 'none';
      });
    } else if (p.isnumber) {
      mainInput = document.createElement('input');
      mainInput.type = 'number';
      mainInput.name = `param_${p.id_parameter}`;
      inputBox.appendChild(mainInput);
    } else {
      mainInput = document.createElement('input');
      mainInput.type = 'text';
      mainInput.name = `param_${p.id_parameter}`;
      inputBox.appendChild(mainInput);
    }

    const uomLabel = document.createElement('div');
    uomLabel.className = 'uom-label';
    uomLabel.textContent = p.uom || '';

    row.appendChild(inputBox);
    row.appendChild(uomLabel);
    parameterForm.appendChild(row);
  }
});

// ===== SUBMIT FORM (existing code) =====
document.getElementById('btnSubmit').addEventListener('click', async (e) => {
  e.preventDefault();
  const selectedRow = timesheetBody.querySelector('tr.selected');
  if (!selectedRow) return alert('Pilih baris timesheet dulu');

  const cells = selectedRow.children;
  const controlRes = await fetch('/process-control', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      production_order: cells[0].textContent,
      ssbr_id: cells[1].textContent,
      operation_text: cells[2].textContent,
      full_name: datakaryawan.full_name,
      snssb: datakaryawan.snssb,
      operation_no: cells[3].textContent,
      workcenter: cells[4].textContent
    })
  });
  const controlData = await controlRes.json();
  const newId = controlData.id_processcontroldata;

  for (const row of parameterForm.querySelectorAll('.form-row')) {
    const selectEl = row.querySelector('select');
    const mainInput = selectEl || row.querySelector('input[type="text"], input[type="number"]');
    const otherEl = row.querySelector('.other-input');
    const uom = row.querySelector('.uom-label').textContent;
    
    let value, id_parameter;
    if (selectEl) {
      id_parameter = selectEl.name.split('_')[1];
      value = selectEl.value === 'Other' ? (otherEl.value || '') : selectEl.value;
    } else {
      id_parameter = mainInput.name.split('_')[1];
      value = mainInput.value;
    }

    await fetch('/process-control-item', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        category_name: categorySelect.options[categorySelect.selectedIndex].text,
        parameter_name: row.querySelector('label').textContent,
        value,
        uom,
        isnumber: row.dataset.isnumber,
        ischoice: row.dataset.ischoice,
        id_parameter,
        id_processcontroldata: newId
      })
    });
  }
  alert('Data berhasil disimpan');
});

// ===== INIT =====
loadCategories();
loadTimesheet();
</script>
</body>
</html>